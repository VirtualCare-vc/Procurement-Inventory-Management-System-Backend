generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id          String    @id @default(cuid())
  name        String
  code        String    @unique
  description String?
  companies   Company[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  isActive    Boolean   @default(true)
   users       User[]  // Tenant-level users (for admin/ownership, not company assignment)

}

model Company {
  id              String           @id @default(cuid())
  tenantId        String
  tenant          Tenant           @relation(fields: [tenantId], references: [id])
  name            String
  code            String           @unique
  description     String?
  sites           Site[]
  numberingRules  NumberingRule[]
  chartOfAccounts ChartOfAccount[]
  currencies      Currency[]
  uoms            UoM[]
  vendors         Vendor[]        
  items           Item[]          
  purchaseOrders  PurchaseOrder[] 
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  isActive        Boolean          @default(true)
  createdById     String?
  createdBy       User?            @relation("CompanyCreatedBy", fields: [createdById], references: [id])
  companyUsers CompanyUser[]
}


model Site {
  id             String           @id @default(cuid())
  companyId      String
  company        Company          @relation(fields: [companyId], references: [id])
  name           String
  code           String           @unique
  address        String?
  city           String?
  country        String?
  purchaseOrders PurchaseOrder[]  // Added relation
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  isActive       Boolean          @default(true)
}

model NumberingRule {
  id         String   @id @default(cuid())
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id])
  module     String 
  prefix     String?
  suffix     String?
  nextNumber Int      @default(1)
  padding    Int      @default(5)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model ChartOfAccount {
  id        String           @id @default(cuid())
  companyId String
  company   Company          @relation(fields: [companyId], references: [id])
  name      String
  code      String           @unique
  parentId  String? // Hierarchical chart structure
  parent    ChartOfAccount?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children  ChartOfAccount[] @relation("AccountHierarchy")
  taxRate   Decimal?         @db.Decimal(5, 2)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  isActive  Boolean          @default(true)
}

model Currency {
  id              String           @id @default(cuid())
  companyId       String
  company         Company          @relation(fields: [companyId], references: [id])
  code            String           @unique
  name            String
  symbol          String?          // Currency symbol (e.g., '$', '€', '£')
  baseRates       ExchangeRate[]   @relation("BaseCurrency")
  targetRates     ExchangeRate[]   @relation("TargetCurrency")
  vendors         Vendor[]         // Added relation
  purchaseOrders  PurchaseOrder[]  // Added relation
  items           Item[]           // Added relation for item pricing
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model ExchangeRate {
  id               String          @id @default(cuid())
  baseCurrencyId   String
  targetCurrencyId String
  rate             Decimal         @db.Decimal(10, 4)
  effectiveDate    DateTime
  purchaseOrders   PurchaseOrder[] // Added relation
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  baseCurrency     Currency        @relation("BaseCurrency", fields: [baseCurrencyId], references: [id])
  targetCurrency   Currency        @relation("TargetCurrency", fields: [targetCurrencyId], references: [id])
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  fullName  String
  roleId    String?
  role      Role?    @relation(fields: [roleId], references: [id])
  tenantId  String  
  tenant    Tenant   @relation(fields: [tenantId], references: [id]) 
  createdAt DateTime @default(now())
  companyUsers CompanyUser[]

  updatedAt DateTime @updatedAt
  isActive  Boolean  @default(true)

  companiesCreated  Company[] @relation("CompanyCreatedBy")
  vendorUsers       VendorUser[]
}


model Role {
  id          String       @id @default(cuid())
  name        String
  description String?
  permissions Permission[] @relation("RolePermissions")
  users       User[]
}

model Permission {
  id          String  @id @default(cuid())
  name        String
  description String?
  module      String?
  action      String? // e.g., read/write/delete
  roles       Role[]  @relation("RolePermissions")
}

model UoM {
  id                String              @id @default(cuid())
  companyId         String
  company           Company             @relation(fields: [companyId], references: [id])
  code              String              // Unique code per company (e.g., 'KG', 'M', 'PCS')
  name              String              // Full name (e.g., 'Kilogram', 'Meter', 'Pieces')
  symbol            String              // Display symbol (e.g., 'kg', 'm', 'pcs')
  description       String?             // Optional description
  fromConversions   UoMConversion[]     @relation("FromUoM")
  toConversions     UoMConversion[]     @relation("ToUoM")
  items             Item[]              // Added relation
  purchaseOrderLines PurchaseOrderLine[] // Added relation
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@unique([companyId, code])
  @@index([companyId, isActive])
}

model UoMConversion {
  id             String   @id @default(cuid())
  fromUomId      String
  toUomId        String
  conversionRate Decimal  @db.Decimal(10, 4)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  fromUom        UoM      @relation("FromUoM", fields: [fromUomId], references: [id])
  toUom          UoM      @relation("ToUoM", fields: [toUomId], references: [id])
}



// adnan

// --- Procurement base masters ---

model Vendor {
  id             String           @id @default(cuid())
  companyId      String
  company        Company          @relation(fields: [companyId], references: [id])
  name           String
  code           String
  email          String?
  phone          String?
  address        String?
  taxNumber      String?
  currencyId     String?   // vendor default currency (optional)
  currency       Currency?        @relation(fields: [currencyId], references: [id])
  purchaseOrders PurchaseOrder[]  // Added relation
  vendorUsers    VendorUser[]     // Users assigned to this vendor
  items          Item[]           // Items with this vendor as preferred
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@unique([companyId, code])
}

model Item {
  id                String              @id @default(cuid())
  companyId         String
  company           Company             @relation(fields: [companyId], references: [id])
  name              String
  code              String
  description       String?             // Item description
  category          String?             // Item category (e.g., 'Raw Material', 'Finished Goods', 'Consumables')
  uomId             String?
  uom               UoM?                @relation(fields: [uomId], references: [id])
  isService         Boolean             @default(false)
  
  // Pricing
  unitPrice         Decimal?            @db.Decimal(18,4) // Standard unit price
  costPrice         Decimal?            @db.Decimal(18,4) // Cost price
  currencyId        String?             // Currency for pricing
  currency          Currency?           @relation(fields: [currencyId], references: [id])
  
  // Tax
  taxRate           Decimal?            @db.Decimal(5,2) // Tax rate percentage
  
  // Stock Management
  trackInventory    Boolean             @default(false) // Whether to track inventory
  minStockLevel     Decimal?            @db.Decimal(18,4) // Minimum stock level
  maxStockLevel     Decimal?            @db.Decimal(18,4) // Maximum stock level
  reorderPoint      Decimal?            @db.Decimal(18,4) // Reorder point
  
  // Vendor Information
  preferredVendorId String?             // Preferred vendor for this item
  preferredVendor   Vendor?             @relation(fields: [preferredVendorId], references: [id])
  
  // Additional Info
  barcode           String?             // Barcode/SKU
  manufacturer      String?             // Manufacturer name
  brand             String?             // Brand name
  specifications    String?             // Technical specifications (JSON or text)
  
  purchaseOrderLines PurchaseOrderLine[] // Added relation
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@unique([companyId, code])
  @@index([companyId, category])
  @@index([companyId, isActive])
}

model CompanyUser {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  company   Company  @relation(fields: [companyId], references: [id])
  companyId String
  role      String   // e.g., 'admin', 'employee', etc.

  @@unique([userId, companyId])
}

model VendorUser {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  vendor    Vendor   @relation(fields: [vendorId], references: [id])
  vendorId  String
  role      String   // e.g., 'contact', 'manager', etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, vendorId])
}

// --- Purchase Order ---

enum POStatus {
  DRAFT
  SUBMITTED
  UNDER_APPROVAL
  APPROVED
  REJECTED
  ISSUED
  CANCELLED
}

model PurchaseOrder {
  id             String         @id @default(cuid())
  companyId      String
  company        Company        @relation(fields: [companyId], references: [id])
  vendorId       String
  vendor         Vendor         @relation(fields: [vendorId], references: [id])
  siteId         String?
  site           Site?          @relation(fields: [siteId], references: [id])
  number         String
  status         POStatus       @default(DRAFT)
  orderDate      DateTime       @default(now())
  currencyId     String?
  currency       Currency?      @relation(fields: [currencyId], references: [id])
  exchangeRateId String?
  exchangeRate   ExchangeRate?  @relation(fields: [exchangeRateId], references: [id])
  remarks        String?
  expectedDeliveryDate DateTime?
  paymentTerms   String?        // e.g., "Net 30", "Net 60"
  shippingAddress String?
  contactPerson  String?
  contactEmail   String?
  contactPhone   String?
  subTotal       Decimal        @db.Decimal(18,2) @default(0)
  taxTotal       Decimal        @db.Decimal(18,2) @default(0)
  grandTotal     Decimal        @db.Decimal(18,2) @default(0)
  createdById    String?
  updatedById    String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  lines          PurchaseOrderLine[]

  @@unique([companyId, number]) // number unique per company
}

model PurchaseOrderLine {
  id             String        @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  lineNo         Int
  itemId         String?
  item           Item?         @relation(fields: [itemId], references: [id])
  description    String
  uomId          String?
  uom            UoM?          @relation(fields: [uomId], references: [id])
  qty            Decimal       @db.Decimal(18,4)
  price          Decimal       @db.Decimal(18,4)
  taxRate        Decimal?      @db.Decimal(5,2)
  lineSubTotal   Decimal       @db.Decimal(18,2) @default(0)
  lineTax        Decimal       @db.Decimal(18,2) @default(0)
  lineTotal      Decimal       @db.Decimal(18,2) @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@unique([purchaseOrderId, lineNo])
}
